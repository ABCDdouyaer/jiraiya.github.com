# 微信公众号开发之生成带场景值二维码及其被动回复消息

> 为了满足用户渠道推广分析和用户帐号绑定等场景的需要，公众平台提供了生成带参数二维码的接口。使用该接口可以获得多个带不同场景值的二维码，用户扫描后，公众号可以接收到事件推送。用户点击微信公众号的按钮或者在公众号发送消息，公众平台可以回复对应的图文及其模板消息

## 准备工作

### 1. 同获取用户信息及其openId流程一样，绑定安全域名及添加IP白名单，查看接口权限

### 2. 设置服务器配置并启用服务器
![8](https://user-images.githubusercontent.com/31639964/54968295-19151e00-4fb5-11e9-83aa-a8408d4911fe.png)

关于服务器地址接口的开发流程见下面的开发流程

## 开发流程

### 1.开发服务器地址接口

该接口主要用于设置服务器的验证以及微信公众消息的接收

当微信发送的请求方式为GET的时候，用于设置服务器配置的验证

当微信发送的请求方式为POST的时候，用于接收微信传输过来的xml消息

### 2.根据接收到的不同消息可以回应不同的内容（包括图文，音乐，语音，视频及其模板消息）

当用户通过场景值二维码进入微信公众号或者在公众号中点击按钮以及发送图文，语音，视频，音乐等都会接收到不同的xml消息，我们可以根据不同的内容回复不同的信息，信息的回复也必须是xml格式，当然也可以回复模板消息，当不会消息时候必须给微信返回success结束响应

### 3.创建按钮

调用微信接口  https://api.weixin.qq.com/cgi-bin/menu/create?access_token=ACCESS_TOKEN 创建按钮

### 4.生成带场景值的二维码

调用微信接口 https://api.weixin.qq.com/cgi-bin/qrcode/create?access_token=TOKEN 获取带场景值的二维码

目前有2种类型的二维码：

1、临时二维码，是有过期时间的，最长可以设置为在二维码生成后的30天（即2592000秒）后过期，但能够生成较多数量。临时二维码主要用于帐号绑定等不要求二维码永久保存的业务场景

2、永久二维码，是无过期时间的，但数量较少（目前为最多10万个）。永久二维码主要用于适用于帐号绑定、用户来源统计等场景。

## 测试方式

当我们在本地测试的时候微信并不能访问到我们用于验证和接受消息的接口

### 1. 下载[natapp](https://natapp.cn/)并按照官网指示安装

### 2. 购买隧道（注册账号可以免费领取一个）设置natapp需要穿透的地址
![9](https://user-images.githubusercontent.com/31639964/54968303-20d4c280-4fb5-11e9-8b21-e90f8d8a0d1e.png)

### 3. 启动natapp获取随机分配的域名
![10](https://user-images.githubusercontent.com/31639964/54968312-27633a00-4fb5-11e9-8e00-d788cd3c11b6.png)

### 4. 公众平台设置服务器配置并启用服务器
![11](https://user-images.githubusercontent.com/31639964/54968315-2e8a4800-4fb5-11e9-91a7-a243a050014e.png)

### 5.关注该测试公众号并进行测试

## 测试demo

[基于koa2写的一个测试demo](https://github.com/ABCDdouyaer/jiraiya.github.io/tree/master/wechat/demo)

## 参考资料

* [微信官方文档](https://mp.weixin.qq.com/wiki?t=resource/res_main&id=mp1443433542)